import { Injectable } from '@nestjs/common';
import axios from "axios";

const mainInstruction = `Ты — эксперт по подбору цветочных букетов. У тебя есть база описаний букетов с чётко структурированной информацией: поводы, настроение, цветовая гамма, состав, стиль, кому дарится, сезон, размер, особенности.
Пользователь вводит несколько параметров (например, "для мамы", "летом", "нежный", "на день рождения", "до 3000 рублей").
Твоя задача — выбрать 1–3 наиболее подходящих букета из базы и кратко объяснить, почему они подходят. Если параметров недостаточно, уточни запрос.

Формат ответа:
Название букета
Краткое описание (2–3 предложения)
Почему он подходит под запрос (1 предложение)
`

const flowers = mainInstruction + `Букет #45nd87: Весеннее утро
Повод: День рождения, романтический жест, весенний праздник
Настроение: Нежность, лёгкость, романтика
Цветовая гамма: Светло-розовая, белая, зелёная
Состав: Тюльпаны, ранункулюсы, эвкалипт
Стиль: Лёгкий, воздушный, женственный
Кому дарится: Женщине, девушке, маме
Сезон: Весна
Размер: Средний
Особенности: Подходит для утреннего вручения, хорошо смотрится без упаковки

Букет #45nd11: Классика чувств
Повод: День святого Валентина, годовщина, признание в любви
Настроение: Страсть, серьёзность, уважение
Цветовая гамма: Красная, бордовая, зелёная
Состав: Красные розы
Стиль: Классический, элегантный
Кому дарится: Женщине, девушке, супруге
Сезон: Универсальный
Размер: Средний или крупный
Особенности: Идеален для торжественных случаев, требует красивой упаковки

Букет #45nd75: Солнечное настроение
Повод: Поздравление, благодарность, поддержка
Настроение: Радость, энергия, оптимизм
Цветовая гамма: Жёлтая, оранжевая, белая
Состав: Герберы, хризантемы, альстромерии
Стиль: Яркий, позитивный
Кому дарится: Коллеге, подруге, маме
Сезон: Весна, лето
Размер: Средний
Особенности: Подходит для поднятия настроения, недорогой

Букет #45nd91: Лавандовое спокойствие
Повод: День рождения, благодарность, утончённый подарок
Настроение: Спокойствие, стиль, утонченность
Цветовая гамма: Сиреневая, розовая, белая
Состав: Лаванда, эустома, маттиола
Стиль: Модный, эстетичный
Кому дарится: Девушке, подруге, творческой натуре
Сезон: Весна, лето
Размер: Компактный или средний
Особенности: Лёгкий аромат, красиво смотрится в вазе

Букет #45nd94: Природная гармония
Повод: Домашний декор, подарок дизайнеру, благодарность
Настроение: Спокойствие, стиль, минимализм
Цветовая гамма: Песочная, зелёная, белая
Состав: Хлопок, сухоцветы, зелень
Стиль: Эко, бохо, минимализм
Кому дарится: Унисекс, паре, дизайнеру, коллегам
Сезон: Осень, зима
Размер: Средний
Особенности: Долго хранится, не требует воды, экологичный стиль`

@Injectable()
export class FlowersService {
  private estimateYandexTokens(text: string) {
    const words = text.trim().split(/\s+/).length;
    return Math.round(words * 1.2); // для русской речи
  }
  private YA_GPT_URL = 'https://llm.api.cloud.yandex.net/foundationModels/v1/completion';

  async askYaGptLite(prompt: string, context: string): Promise<any> {
    const data =
    {
      "modelUri": "gpt://b1g0r6nfpeiov2osd3it/yandexgpt-lite",
      "completionOptions": {
        "stream": false,
        "temperature": 0.5, // по умолчанию было .6
        "maxTokens": "100",
        "reasoningOptions": {
          "mode": "DISABLED"
        }
      },
      "messages": [
        {
          "role": "system",
          "text": flowers // сюда передать context
        },
        {
          "role": "user",
          "text": prompt
        }
      ]
    }

    let response = await axios.post(this.YA_GPT_URL, data, {
      headers: {
        Authorization: `Api-Key ${process.env.YC_AI_API_KEY}`,
        'Content-Type': 'application/json'
      }
    })

    return response.data
  }
}
